<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Controlo do Processo - SysSense</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f7f9;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #ffffff;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border-bottom: 3px solid #2980b9;
    }

    .logo {
      height: 55px;
      margin-right: 16px;
    }

    .main {
      display: flex;
      justify-content: center;
      gap: 40px;
      padding: 50px 20px;
      flex-wrap: wrap;
    }

    .card {
      background: white;
      width: 380px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      border-radius: 12px;
    }

    h2 {
      color: #2c3e50;
      font-size: 22px;
      margin-bottom: 10px;
    }

    p {
      color: #555;
      margin-bottom: 12px;
    }

    button {
      background: linear-gradient(to right, #3498db, #2980b9);
      color: white;
      padding: 10px 24px;
      margin: 6px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 500;
    }

    button:hover {
      background: linear-gradient(to right, #2471a3, #1f618d);
    }

    .inputs-auto {
      display: none;
      margin-top: 15px;
    }

    input[type=number] {
      padding: 8px;
      margin: 5px;
      width: 110px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    .resposta {
      margin-top: 12px;
      font-weight: 600;
      color: #27ae60;
    }

    .info {
      margin-top: 12px;
      font-size: 15px;
      color: #333;
    }

    @media (max-width: 800px) {
      .main {
        flex-direction: column;
        align-items: center;
      }

      .card {
        width: 90%;
      }
    }
  </style>
</head>
<body>

<header>
  <img src="/static/syssense_logo.png" alt="SysSense Logo" class="logo">
  <div style="margin-left: auto;">
    <a href="http://192.168.100.2:3000/" style="background: linear-gradient(to right, #3498db, #2980b9); color: white; padding: 10px 18px; border-radius: 8px; text-decoration: none;">
      Monitor
    </a>
  </div>
</header>

<div class="main">

<!-- VENTILADOR -->
<div class="card">
  <h2>Controlo do Ventilador</h2>
  <p>Escolha o modo de funcionamento:</p>
  <button onclick="definirModoTemp('manual')">Modo Manual</button>
  <button onclick="definirModoTemp('auto')">Modo Auto</button>

  <!-- Modo Manual -->
  <div id="manual-controls-temp" style="display: none;">
    <button id="botaoModoTemp" onclick="alternarModoTemp()">Ligar Ventilador</button>
  </div>

  <!-- Modo Auto -->
  <div id="auto-controls-temp" class="inputs-auto">
    <p>Limites de temperatura:</p>
    <input type="number" id="tempMin" placeholder="Temp. Min.">
    <input type="number" id="tempMax" placeholder="Temp. Max.">
    <br>
    <button onclick="iniciarAutoTemp()">Aplicar</button>
    <button onclick="pararAutoTemp()">Desativar Auto</button>
  </div>

  <div class="info" id="info_temp">Temperatura atual: -- °C</div>
  <p class="resposta" id="resposta_temp"></p>
</div>


<!-- HUMIDIFICADOR -->
<div class="card">
  <h2>Controlo do Humidificador</h2>
  <p>Escolha o modo de funcionamento:</p>
  <button onclick="definirModoHum('manual')">Modo Manual</button>
  <button onclick="definirModoHum('auto')">Modo Auto</button>

  <!-- Modo Manual -->
  <div id="manual-controls-hum" style="display: none;">
    <button id="botaoModoHum" onclick="alternarModoHum()">Ligar Humidificador</button>
  </div>

  <!-- Modo Auto -->
  <div id="auto-controls-hum" class="inputs-auto">
    <p>Limites de humidade:</p>
    <input type="number" id="humMin" placeholder="Hum. Min.">
    <input type="number" id="humMax" placeholder="Hum. Max.">
    <br>
    <button onclick="iniciarAutoHum()">Aplicar</button>
    <button onclick="pararAutoHum()">Desativar Auto</button>
  </div>

  <div class="info" id="info_hum">Humidade atual: -- %</div>
  <p class="resposta" id="resposta_hum"></p>
</div>


  <!-- Webcam -->
  <div class="card">
    <h2>Visualizador</h2>
    <p>Cam ao vivo do ambiente:</p>
    <div style="display: flex; justify-content: center;">
      <video id="mini-video" autoplay muted playsinline width="320" height="200"
        style="border: 2px solid #3498db; border-radius: 8px; cursor: pointer;" onclick="abrirModal()">
      </video>
    </div>
  </div>

  <div id="modal-stream" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
       background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000;">
    <div style="background: #fff; padding: 20px; border-radius: 10px;">
      <video id="full-video" autoplay muted playsinline width="800" height="500"
        style="border: 2px solid #2980b9; border-radius: 10px;"></video>
      <div style="text-align: right; margin-top: 10px;">
        <button onclick="fecharModal()" style="padding: 6px 12px;">Fechar</button>
      </div>
    </div>
  </div>
</div>

<script>
  let estadoManualTemp = 'off';
  let estadoManualHum = 'off';
  let intervaloTemp = null;
  let intervaloHum = null;

  function definirModoTemp(modo) {
    document.getElementById('manual-controls-temp').style.display = modo === 'manual' ? 'block' : 'none';
    document.getElementById('auto-controls-temp').style.display = modo === 'auto' ? 'block' : 'none';

    if (modo === 'manual') {
      if (intervaloTemp) {
        clearInterval(intervaloTemp);
        intervaloTemp = null;
        document.getElementById('resposta_temp').innerText = "Modo Auto desativado.";
      }
      atualizarTextoBotaoTemp();
    }

    if (modo === 'auto') {
      if (estadoManualTemp === 'on') {
        alert("Desliga primeiro o ventilador manual para usar o modo auto.");
        document.getElementById('auto-controls-temp').style.display = 'none';
      }
    }
  }

  function definirModoHum(modo) {
    document.getElementById('manual-controls-hum').style.display = modo === 'manual' ? 'block' : 'none';
    document.getElementById('auto-controls-hum').style.display = modo === 'auto' ? 'block' : 'none';

    if (modo === 'manual') {
      if (intervaloHum) {
        clearInterval(intervaloHum);
        intervaloHum = null;
        document.getElementById('resposta_hum').innerText = "Modo Auto desativado.";
      }
      atualizarTextoBotaoHum();
    }

    if (modo === 'auto') {
      if (estadoManualHum === 'on') {
        alert("Desliga primeiro o humidificador manual para usar o modo auto.");
        document.getElementById('auto-controls-hum').style.display = 'none';
      }
    }
  }

  async function alternarModoTemp() {
    if (estadoManualTemp === 'off') {
      await controlar('temp', 'on');
      estadoManualTemp = 'on';
    } else {
      await controlar('temp', 'off');
      estadoManualTemp = 'off';
    }
    atualizarTextoBotaoTemp();
  }

  async function alternarModoHum() {
    if (estadoManualHum === 'off') {
      await enviarImpulsos(1); // ligar
      estadoManualHum = 'on';
    } else {
      await enviarImpulsos(2); // desligar
      estadoManualHum = 'off';
    }
    atualizarTextoBotaoHum();
  }

  function atualizarTextoBotaoTemp() {
    const texto = estadoManualTemp === 'on' ? 'Desligar Ventilador' : 'Ligar Ventilador';
    document.getElementById('botaoModoTemp').innerText = texto;
  }

  function atualizarTextoBotaoHum() {
    const texto = estadoManualHum === 'on' ? 'Desligar Humidificador' : 'Ligar Humidificador';
    document.getElementById('botaoModoHum').innerText = texto;
  }

  async function controlar(tipo, estado) {
    const resposta = await fetch(`/relay_${tipo}/${estado}`, { method: 'POST' });
    const resultado = await resposta.json();
    document.getElementById(`resposta_${tipo}`).innerText = resultado.status || resultado.error;
  }

  function iniciarAutoTemp() {
    const min = parseFloat(document.getElementById("tempMin").value);
    const max = parseFloat(document.getElementById("tempMax").value);

    if (isNaN(min) || isNaN(max) || min >= max) {
      document.getElementById("resposta_temp").innerText = "Limites inválidos.";
      return;
    }

    if (estadoManualTemp === 'on') {
      alert("Desliga o ventilador manual primeiro.");
      return;
    }

    if (intervaloTemp) clearInterval(intervaloTemp);

    verificarLimitesTemp(min, max);
    intervaloTemp = setInterval(() => verificarLimitesTemp(min, max), 5000);
  }

  async function verificarLimitesTemp(min, max) {
    try {
      const response = await fetch('/ultima_temperatura_cupula');
      const data = await response.json();
      const valor = parseFloat(data.valor);

      if (!isNaN(valor)) {
        if (valor <= min) await controlar('temp', 'on');
        else if (valor >= max) await controlar('temp', 'off');
      }
    } catch {
      document.getElementById("resposta_temp").innerText = "Erro ao obter temperatura.";
    }
  }

  function iniciarAutoHum() {
    const min = parseFloat(document.getElementById("humMin").value);
    const max = parseFloat(document.getElementById("humMax").value);

    if (isNaN(min) || isNaN(max) || min >= max) {
      document.getElementById("resposta_hum").innerText = "Limites inválidos.";
      return;
    }

    if (estadoManualHum === 'on') {
      alert("Desliga o humidificador manual primeiro.");
      return;
    }

    if (intervaloHum) clearInterval(intervaloHum);

    verificarLimitesHum(min, max);
    intervaloHum = setInterval(() => verificarLimitesHum(min, max), 5000);
  }

async function verificarLimitesHum(min, max) {
  // Impede funcionamento se estiver em modo manual
  if (estadoManualHum === 'on') return;

  try {
    const response = await fetch('/ultima_humidade');
    const data = await response.json();
    const valor = parseFloat(data.valor);

    if (!isNaN(valor)) {
      if (valor <= min) {
        await enviarImpulsos(1); // Ligar
        estadoManualHum = 'on';
      } else if (valor >= max) {
        await enviarImpulsos(2); // Desligar
        estadoManualHum = 'off';
      }
      atualizarTextoBotaoHum();
    }
  } catch {
    document.getElementById("resposta_hum").innerText = "Erro ao obter humidade.";
  }
}




  function pararAutoTemp() {
    if (intervaloTemp) {
      clearInterval(intervaloTemp);
      intervaloTemp = null;
    }
    controlar('temp', 'off');
    document.getElementById("tempMin").value = '';
    document.getElementById("tempMax").value = '';
    document.getElementById("resposta_temp").innerText = "Modo Auto desativado.";
    document.getElementById("resposta_temp").style.color = "green";
  }

  function pararAutoHum() {
    if (intervaloHum) {
      clearInterval(intervaloHum);
      intervaloHum = null;
    }
    enviarImpulsos(2); // desligar
    document.getElementById("humMin").value = '';
    document.getElementById("humMax").value = '';
    document.getElementById("resposta_hum").innerText = "Modo Auto desativado.";
    document.getElementById("resposta_hum").style.color = "green";
  }

  async function enviarImpulsos(qtd) {
    for (let i = 0; i < qtd; i++) {
      await controlar('hum', 'on');
      await esperar(500);
      await controlar('hum', 'off');
      await esperar(500);
    }
  }

  function esperar(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function iniciarStreamDroidCam() {
    try {
      const permissao = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      permissao.getTracks().forEach(track => track.stop());
      const devices = await navigator.mediaDevices.enumerateDevices();
      const droidCam = devices.find(d => d.kind === "videoinput" && d.label.toLowerCase().includes("droidcam"));
      const constraints = { video: droidCam ? { deviceId: { exact: droidCam.deviceId } } : true, audio: false };
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      document.getElementById("mini-video").srcObject = stream;
      document.getElementById("full-video").srcObject = stream;
    } catch (e) {
      console.error("Erro ao iniciar câmara:", e);
    }
  }

  function abrirModal() {
    document.getElementById("modal-stream").style.display = "flex";
  }

  function fecharModal() {
    document.getElementById("modal-stream").style.display = "none";
  }

  async function atualizarInfos() {
    try {
      const [temp, hum] = await Promise.all([
        fetch('/ultima_temperatura_cupula').then(r => r.json()),
        fetch('/ultima_humidade').then(r => r.json())
      ]);
      document.getElementById("info_temp").innerText = `Temperatura atual: ${temp.valor ?? "--"} °C`;
      document.getElementById("info_hum").innerText = `Humidade atual: ${hum.valor ?? "--"} %`;
    } catch {
      document.getElementById("info_temp").innerText = "Erro ao atualizar.";
      document.getElementById("info_hum").innerText = "Erro ao atualizar.";
    }
  }

  window.onload = () => {
    iniciarStreamDroidCam();
    atualizarInfos();
  };

  setInterval(atualizarInfos, 5000);
</script>


</body>
</html>
